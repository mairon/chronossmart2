<%=raw current_user.menu_code %>
<ul class="nav navbar-nav navbar-right">
  <li><a href="/tarefas"><i class="icon-white icon-calendar"></i></a></li>
  <li class="divider-vertical"></li>
  <li><i class="icon-white icon-th"></i>
    <%= select("busca", "unidade", UnidadesUsuario.joins(:unidade).where("unidades_usuarios.usuario_id = #{current_user.id}").all(:select => 'unidades_usuarios.id, (unidades.unidade_nome) as unidade_nome, unidades_usuarios.unidade_id').collect {|p| [ p.unidade_nome, p.unidade_id ] }, {selected: current_unidade.id  }, {class: 'hidden-select'}) %>
</a></li>
  <li class="dropdown">
  	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
  		<i class="icon-white icon-user"></i> <%= current_user.usuario_nome %> <small>(<%= I18n.locale %>)</small> <span class="caret"></span>
  	</a>

  	<ul class="dropdown-menu">
    <% if session[:logged] %>
      <li><%= link_to "logout", new_login_path, :action => :delete %></li>
    <% end %>
  	</ul>
  </li>
</ul>

<script>
$('#busca_unidade').change(function() {
            $.ajax({url: "/logins/troca_unidade",
              type: 'POST',
              data: { 'busca[unidade_id]':  $('#busca_unidade').val(), 'busca[usuario_id]': <%= current_user.id %> },
              beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
              success: function(){
                  window.location.reload();
                }
            });             
          });  
</script>